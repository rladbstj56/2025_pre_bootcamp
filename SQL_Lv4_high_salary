# 문제 링크: https://nbc-precamp-data.oopy.io/29a2dc3e-f514-8119-ab35-ebcdb243c77a

CREATE TABLE basic.Employees2 (
    EmployeeID INT PRIMARY KEY,
    Name VARCHAR(50) NOT NULL,
    Department VARCHAR(50),
    Salary INT,
    ManagerID INT
);


INSERT INTO Employees2 (EmployeeID, Name, Department, Salary, ManagerID) VALUES
(1, 'Alice', 'HR', 70000, NULL),
(2, 'Bob', 'IT', 90000, 1),
(3, 'Charlie', 'IT', 80000, 2),
(4, 'David', 'IT', 85000, 2),
(5, 'Eve', 'HR', 75000, 1),
(6, 'Frank', 'Finance', 95000, NULL),
(7, 'Grace', 'Finance', 80000, 6),
(8, 'Heidi', 'IT', 95000, 2);

select * from employees2


# 문제 1 

# 내가 쓴 쿼리
with ranked as (
select 
	employeeid,
	name, 
	department, 
	row_number() over (partition by department order by salary desc) 
		as rnk, 
	salary
from basic.employees2 
), 
final_ranked as ( 
select r.name, r.department, r.salary 
from ranked r 
where rnk = 1
) 
select e.name, e.department, e.salary, f.name, f.salary 
from basic.employees2 e
join final_ranked f
on e.department = f.department 

# 정답 쿼리
select e1.name, e1.department, e1.salary,
	   e2.name as top_earner, e2.salary as top_salary
from basic.employees2 e1
join basic.employees2 e2 on e1.department = e2.department 
where e2.salary = ( 
	select max(salary) 
	from basic.employees2 e3
	where e3.department = e1.department
	);


# 문제 2 

# 내가 작성한 쿼리
with highest as (
select 
	department, 
	avg(salary) as avg_sal, 
	rank() over (order by avg(salary) desc) as rnk
from basic.employees2
group by department
) 
select h.department, h.avg_sal 
from highest h
where h.rnk = 1


# 정답 쿼리 
select department, avg(salary)
from basic.employees2 
group by department 
having avg(salary) = ( 
	select max(avg_salary) 
	from 
		(select avg(salary) as avg_salary 
		 from basic.employees2 
		 group by department) as subquery
	);



